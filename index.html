<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>recipe</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/recipe.css?20190109" media="all">
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  
  
  <body>
  
    <div class="scroll-box">
      <div class="scroll-content"></div>
    </div>
      
      
      <div id="main">
      
      
          <div id="info1">
              
              <p>製作数の入力</p>
              <input type="number" name="num" id="sak" placeholder="数量を入力">
              
              <p>皇室納品</p>
              <form id="erabu">
                    <label><input type="radio" name="sort" value="all" checked>全て</label>
                    <label><input type="radio" name="sort" value="見習い">見習</label>
                    <label><input type="radio" name="sort" value="熟練">熟練</label>
                    <label><input type="radio" name="sort" value="専門">専門</label><br>
                    <label><input type="radio" name="sort" value="職人">職人</label>
                    <label><input type="radio" name="sort" value="名匠">名匠</label>
                    <label><input type="radio" name="sort" value="道人">道人</label>
              </form>
              
              
              <dl id="sozai">
                    <dt class="midashi">互換素材</dt>
                    
                        <dl class="nakami">
                            <dt class="nakami_2">穀物類</dt>
                                <dd>ジャガイモ・大麦・小麦<br>トウモロコシ・サツマイモ・米</dd>
                            <dt class="nakami_2">野菜類</dt>
                                <dd>カボチャ・キャベツ・トマト<br>パプリカ・オリーブ・白菜</dd>
                            <dt class="nakami_2">魚類</dt>
                                <dd>川魚・海魚全般</dd>
                            <dt class="nakami_2">海産物</dt>
                                <dd>貝・イカ・カニ・クラゲ<br>コウイカ・タコ・タツノオトシゴ<br>
                                ヒトデ・スッポン・ザリガニ<br>ベニズワイガニ</dd>
                            <dt class="nakami_2">一般肉類</dt>
                                <dd>羊肉・豚肉・牛肉・イタチ肉<br>オオカミ肉・キツネ肉・クマ肉<br>
                                サイの肉・シカ肉・タヌキ肉・ヤギ肉</dd>
                            <dt class="nakami_2">鳥肉</dt>
                                <dd>鶏肉・フラミンゴ肉・クークー鳥肉</dd>
                            <dt class="nakami_2">爬虫類肉</dt>
                                <dd>リザード肉・ワラゴンの肉<br>チータードラゴン肉・ワーム肉</dd>
                            <dt class="nakami_2">ワニ肉</dt>
                                <dd>ワニの肉・ぶよぶよしたクジラの肉</dd>
                            <dt class="nakami_2">マーモット肉</dt>
                                <dd>マーモット肉・ヤクの肉</dd>
                            <dt class="nakami_2">フルーツ類</dt>
                                <dd>リンゴ・ブドウ・イチゴ<br>サクランボ・ナシ・バナナ<br>パイナップル・山いちご・柿</dd>
                            <dt class="nakami_2">花類</dt>
                                <dd>チューリップ・ヒマワリ・バラ</dd>
                            <dt class="nakami_2">油類</dt>
                                <dd>オリーブオイル・コーン油・綿実油</dd>
                            <dt class="nakami_2">草</dt>
                                <dd>野生野草＝雑草4～5　試薬のみ1</dd>
                                <dd>野生薬草の束or山各種＝ノーマル3個分</dd>
                                <dd>高級薬草＝ノーマル3個分</dd>
                                <dd>特級薬草＝ノーマル7個分</dd>
                            <dt class="nakami_2">血</dt>
                                <dd>[クマ＝ライオン＝トロル＝オーガ＝ヤク］</dd>
                                <dd>[キツネ＝サソリ＝イタチ＝タヌキ]</dd>
                                <dd>[オオカミ＝サイ＝フラミンゴ＝ﾁｰﾀｰﾄﾞﾗｺﾞﾝ]</dd>
                                <dd>[豚＝鹿＝羊＝牛＝ワラゴン＝ラマ＝ヤギ]</dd>
                                <dd>[リザード＝ワーム＝コウモリ＝クークー鳥］</dd>
                            <dt class="nakami_2">その他</dt>
                                <dd>精製水＝蒸留水</dd>
                                <dd>HPポーション(中)＝HPポーション(小)</dd>
                                <dd>MPポーション(中)＝MPポーション(小)</dd>
                                <dd>HPポーション(大)＝HPポーション(小)3</dd>
                                <dd>MPポーション(大)＝MPポーション(小)3</dd>
                                <dd>溶けた鉄の欠片＝鉄鉱石9～10</dd>
                                <dd>大きなキノコ各種＝ノーマル3</dd>
                                <dd>高級＝ノーマル2</dd>
                                <dd>特級＝ノーマル4</dd>
                                <dd>リンゴ＝フルーツ類</dd>
                        </dl>
                        
                    <dt class="midashi">加工素材</dt>
                        <dl class="nakami">
                            <dt class="nakami_2">穀物粉類</dt>
                                <dd>穀物類を粉砕</dd>
                            <dt class="nakami_2">穀物生地類</dt>
                                <dd>穀物粉類と料理用ミネラルウォーターを混合</dd>
                            <dt class="nakami_2">クリーム</dt>
                                <dd>牛乳と砂糖を混合</dd>
                            <dt class="nakami_2">バター</dt>
                                <dd>クリームと塩を混合</dd>
                            <dt class="nakami_2">チーズ</dt>
                                <dd>牛乳を乾燥</dd>
                            <dt class="nakami_2">食用蜂蜜</dt>
                                <dd>野生のハチの巣を粉砕</dd>
                            <dt class="nakami_2">塩</dt>
                                <dd>海の水で満たしたビンを加熱</dd>
                            <dt class="nakami_2">みじん切りにした鳥肉</dt>
                                <dd>鳥肉・鶏肉を粉砕</dd>
                        </dl>
              <div class="scroll-box2">
                <div class="scroll-content2"></div>
              </div>
              </dl>
              
              
          </div>
          
          
          <div id="info2">

              <button id="collapseAll">すべて閉じる</button>

              <p id="cook">料理</p>
                        <ul class="cook_na1">
                        </ul>
                    
              <p id="alc">錬金</p>
                    
                        <ul id="alc_na1">                        
                        </ul>
              
              
              
          </div>
      
      
      </div>
      
      
      <script>
          

          function renderRecipeTree(recipe, allRecipes, multiplier = 1) {
            const $li = $(`<li class="openable recipe-item"></li>`);
            const $label = $(`<span class="recipe-label" data-name="${recipe.レシピ}">${recipe.レシピ}　… ${multiplier}</span>`);
            $li.append($label);
          
            const $detail = $('<ul style="display: none;"></ul>');
            let hasChild = false;
            
            
            for (let i = 1; i <= 5; i++) {
              const material = recipe[`素材${i}`];
              const qty = recipe[`分量${i}`];
          
              if (material && qty) {
                const scaledQty = qty * multiplier;
                const subRecipe = allRecipes.find(r => r.レシピ === material); // ← ここで定義！
          
                if (subRecipe) {
                  const $child = renderRecipeTree(subRecipe, allRecipes, scaledQty);
                  
                  if ($child.hasClass("has-child")) {
                    hasChild = true;
                  }
                  
                  $detail.append($child);
                } else {
                // 単素材
                  $detail.append(`<li>${material} 　… ${scaledQty}</li>`);
                }

              }
            }
            
            if (hasChild) {
              $li.addClass("has-child");
              $label.addClass("has-child-label");
            }
            
            $li.append($detail);
            return $li; 
          }
          
          
          function renderCookingList(data, $container,multiplier) {
            $container.empty();
            const grouped = data.reduce((acc, item) => {
              if (!acc[item.五十音]) acc[item.五十音] = [];
              acc[item.五十音].push(item);
              return acc;
            }, {});
            for (const [group, recipes] of Object.entries(grouped)) {
              const $groupLi = $(`<li class="openable category-group"><strong>${group}</strong></li>`);
              const $subList = $('<ul style="display: none;"></ul>');
              for (const recipe of recipes) {
                $subList.append(renderRecipeTree(recipe, data, multiplier));
              }
              $groupLi.append($subList);
              $container.append($groupLi);
            }
          }


          function renderAlchemyList(data, $container,multiplier) {
            $container.empty();
            const grouped = data.reduce((acc, item) => {
              if (!acc[item.分類]) acc[item.分類] = [];
              acc[item.分類].push(item);
              return acc;
            }, {});
            for (const [group, recipes] of Object.entries(grouped)) {
              const $groupLi = $(`<li class="openable category-group"><strong>${group}</strong></li>`);
              const $subList = $('<ul style="display: none;"></ul>');
              for (const recipe of recipes) {
                $subList.append(renderRecipeTree(recipe, data, multiplier));
              }
              $groupLi.append($subList);
              $container.append($groupLi);
            }
          }


          function filterByDeliveryType(data, value) {
            return value === "all" ? data : data.filter(item => item.納品種別 === value);
          }




          $(function(){
              //アコーディオン動作
              $('.nakami_2').click(function(event){
                $(this).next().slideToggle();
                $(this).toggleClass("open");
              });
              
          });
          
          $(document).on("click",".openable",function (e) {
              e.stopPropagation();
              $(this).toggleClass("open")
              $(this).children("ul").slideToggle();
              
          });
          
          $(document).on("click", "#collapseAll", function () {
            $(".openable.open").removeClass("open").children("ul").slideUp();
            
            //展開状態をクリア
            sessionStorage.removeItem("openRecipes");
            sessionStorage.removeItem("openGroups");
          });
          
          
          
          let cookingData = [];
          let alchemyData = [];
          
          
          function saveOpenState() {
            const openRecipes = $(".recipe-label").filter(function () {
              return $(this).closest('.openable').hasClass('open');
            }).map(function () {
              return $(this).data('name');
            }).get();
            
            const openGroups = $(".category-group").filter(function () {
              return $(this).hasClass('open');
              }).map(function () {
              return $(this).find("strong").text();
            }).get();
            
            sessionStorage.setItem("openRecipes", JSON.stringify(openRecipes));
            sessionStorage.setItem("openGroups", JSON.stringify(openGroups));
          }
          
          
          function restoreOpenState() {
            const openRecipes = JSON.parse(sessionStorage.getItem("openRecipes") || "[]");
            const openGroups = JSON.parse(sessionStorage.getItem("openGroups") || "[]");
            
            $(".recipe-label").each(function () {
              if (openRecipes.includes($(this).data("name"))) {
                const $li = $(this).closest('.openable');
                $li.addClass("open");
                $li.children("ul").show();
              }
            });
            
            $(".category-group").each(function () {
              const groupName = $(this).find("strong").text();
              if (openGroups.includes(groupName)) {
                $(this).addClass("open");
                $(this).children("ul").show();
              }
            });
          }

          
          function renderAll(multiplier = 1) {
            saveOpenState();
            const val = $('#erabu input[name="sort"]:checked').val() || "all";
            
            
            // 再描画
            renderCookingList(filterByDeliveryType(cookingData, val), $(".cook_na1"), multiplier);
            renderAlchemyList(filterByDeliveryType(alchemyData, val), $("#alc_na1"), multiplier);
            
            restoreOpenState();
            
          }
          
          $(function () {
            let multiplier = parseFloat($('#sak').val()) || 1;
            
            $('#sak').on('input', function () {
              multiplier = parseFloat($(this).val()) || 1;
              renderAll(multiplier);
            });
            
            $('#erabu input[name="sort"]').on('change', function () {
              renderAll(multiplier);
            });
            
            $.getJSON("json/cooking.json", function (cookData) {
              cookingData = cookData;
              $.getJSON("json/alchemy.json", function (alcData) {
                alchemyData = alcData;
                renderAll(multiplier); // データ取得後に描画
              });
            });
          });


      </script>
      
      
  </body>
  
</html>